<html>
	<head>
		<title>Tempmon</title>
	</head>
	
	<body>
		<div>
			<div>
				<canvas id="theCanvas" width="320" height="200" style="border:1px solid #000000;" tabindex="0">
					Your browser does not support the HTML5 canvas tag.
				</canvas>

				<div id="theDiv">...</div>
			</div>
		</div>
	</body>
	
	<script>
		function makeHttpRequestPromise( url, method, data, headers )
		{
			var promise = new Promise(
				function(resolve, reject) 
				{
					var request = new XMLHttpRequest();
					request.open( method, url );
					if ( headers )
					{
						for ( var header in headers )
						{
							if ( headers.hasOwnProperty(header) )
							{
								request.setRequestHeader(header, headers[header]);
							}
						}
					}

					request.onload = function( event ) 	 
						{
							if ( request.status===200 )
							{
								resolve( request.response );
							}
							else
							{
								reject( new Error(request.status ) );
							}
						};

					request.onerror = function( event )		
						{
							reject( new Error(request.status ) );
						};
			
					try
					{
						request.send(data);
					}
					catch (exception)
					{
						reject( exception );
					}
				});
			return promise;
		}
		
		function createUint8ArrayFromMessageString( messageString )
		{
			// http://stackoverflow.com/questions/1597709/convert-a-string-with-a-hex-representation-of-an-ieee-754-double-into-javascript
			var messageLengthInBytes = 12;
			var buffer = new ArrayBuffer(messageLengthInBytes);
			var uint8Array = new Uint8Array( buffer );
			for ( var i=0; i<messageLengthInBytes; i++ )
			{
				var byteAsHex = messageString.substr( i*2, 2 );
				var byte = parseInt( byteAsHex, 16 );
				uint8Array[i] = byte;
			}
			return uint8Array;
		}

		function getWeatherDataFromUint8Array( uint8Array )
		{
			var dataView = new DataView(uint8Array.buffer);
			var weatherData = {
				pressure: dataView.getUint32(0),		
				temperature: dataView.getFloat32(4),
				humidity: dataView.getUint32(8)
			}
			return weatherData;
		}

		var m = "000003f141c4fcc100000033";
		var b = createUint8ArrayFromMessageString(m);
		var data = getWeatherDataFromUint8Array(b);

		var canvas = document.getElementById('theCanvas');
		var ctx = canvas.getContext("2d");
		ctx.moveTo(0,0);
		ctx.lineTo(200,100);
		ctx.stroke();

		var div = document.getElementById('theDiv');
		div.innerHTML = 'toto';

		makeHttpRequestPromise( '/api/devices/1D80C/messages', 'GET')
			.then(
				function( response )
				{
					var messages = JSON.parse(response);
					div.innerHTML = messages.data.length;
					for ( var i=0; i<messages.data.length; ++i  )
					{
						var message = messages.data[i];
						var numSecondsSinceEpoch = message.time;
						var date = new Date( numSecondsSinceEpoch * 1000 );
						var weatherData = getWeatherDataFromUint8Array( createUint8ArrayFromMessageString( message.data ) );

						div.innerHTML += "<div>" + date.toString() + ": " + JSON.stringify(weatherData) + "</div>";
					}
				})
			.catch(
				function( error )
				{
					div.innerHTML = error.toString();
				});
	</script>
	
</html>
