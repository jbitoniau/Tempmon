<html>
	<head>
		<title>Tempmon</title>
	</head>
	
	<body>
		<div style="position:absolute; top:5px; left:5px; bottom:5px; right:5px; display:flex; flex-direction:column;">
			<canvas id="theCanvas" style="flex:1 1 200px; border:1px solid #000000;" tabindex="0">
				Your browser does not support the HTML5 canvas tag.
			</canvas>

			<div id="theDiv">...</div>
		</div>
	</body>
	
	<script>
		function makeHttpRequestPromise( url, method, data, headers )
		{
			var promise = new Promise(
				function(resolve, reject) 
				{
					var request = new XMLHttpRequest();
					request.open( method, url );
					if ( headers )
					{
						for ( var header in headers )
						{
							if ( headers.hasOwnProperty(header) )
							{
								request.setRequestHeader(header, headers[header]);
							}
						}
					}

					request.onload = function( event ) 	 
						{
							if ( request.status===200 )
							{
								resolve( request.response );
							}
							else
							{
								reject( new Error(request.status ) );
							}
						};

					request.onerror = function( event )		
						{
							reject( new Error(request.status ) );
						};
			
					try
					{
						request.send(data);
					}
					catch (exception)
					{
						reject( exception );
					}
				});
			return promise;
		}
		
		function createUint8ArrayFromMessageString( messageString )
		{
			// http://stackoverflow.com/questions/1597709/convert-a-string-with-a-hex-representation-of-an-ieee-754-double-into-javascript
			var messageLengthInBytes = 12;
			var buffer = new ArrayBuffer(messageLengthInBytes);
			var uint8Array = new Uint8Array( buffer );
			for ( var i=0; i<messageLengthInBytes; i++ )
			{
				var byteAsHex = messageString.substr( i*2, 2 );
				var byte = parseInt( byteAsHex, 16 );
				uint8Array[i] = byte;
			}
			return uint8Array;
		}

		function getWeatherDataFromUint8Array( uint8Array )
		{
			var dataView = new DataView(uint8Array.buffer);
			var weatherData = {
				pressure: dataView.getUint32(0),		
				temperature: dataView.getFloat32(4),
				humidity: dataView.getUint32(8)
			}
			return weatherData;
		}

		function updateCanvas( messages )
		{
			var canvas = document.getElementById('theCanvas');

			var w = canvas.clientWidth;
			var h = canvas.clientHeight;

			canvas.width = w;
			canvas.height = h;
			
			var sx = 10;

			var oy = 10;
			var sy = 30;

			var temperaturePoints = [];
			for ( var i=0; i<messages.data.length; i++ )
			{
				var temperature = messages.data[i].weatherData.temperature;
				var pt = {
					x: w - (i * sx),
					y: h - ( (temperature-oy) * sy)
				};
				temperaturePoints.push( pt );
			}

			var ctx = canvas.getContext("2d");
			ctx.beginPath();
			ctx.strokeStyle="#999999";
			for ( var i=0; i<temperaturePoints.length; i++ )
			{
				var pt = temperaturePoints[i];
				ctx.lineTo( pt.x, pt.y );
				ctx.stroke();
			}

			//ctx.strokeStyle="#FF0000";
			ctx.fillStyle="#222222";
			for ( var i=0; i<temperaturePoints.length; i++ )
			{
				var pt = temperaturePoints[i];
				ctx.fillRect(pt.x-2, pt.y-2, 4, 4);
			}
		}


		function main()
		{
			var m = "000003f141c4fcc100000033";
			var b = createUint8ArrayFromMessageString(m);
			var data = getWeatherDataFromUint8Array(b);

			var div = document.getElementById('theDiv');
			div.innerHTML = 'toto';

			makeHttpRequestPromise( '/api/devices/1D80C/messages', 'GET')
				.then(
					function( response )
					{
						var messages = JSON.parse(response);
						div.innerHTML = messages.data.length;
						for ( var i=0; i<messages.data.length; ++i  )
						{
							var message = messages.data[i];
							var numSecondsSinceEpoch = message.time;
							var date = new Date( numSecondsSinceEpoch * 1000 );
							var weatherData = getWeatherDataFromUint8Array( createUint8ArrayFromMessageString( message.data ) );

							// Store decoded data directly in the response object
							message.weatherData = weatherData;
							message.date = date;

							//div.innerHTML += "<div>" + date.toString() + ": " + JSON.stringify(weatherData) + "</div>";
						}

						updateCanvas( messages );
					})
				.catch(
					function( error )
					{
						div.innerHTML = error.toString();
					});
		}

		main();
		
	</script>
	
</html>
