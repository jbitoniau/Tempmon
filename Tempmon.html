<html>
	<head>
		<title>Tempmon</title>
	</head>
	
	<body>
		<div style="position:absolute; top:15px; left:15px; bottom:15px; right:15px;">
			<canvas id="theCanvas" style="width:100%; height:100%; border:1px solid rgba(255, 0, 0, 0.3);" tabindex="0">
				Your browser does not support the HTML5 canvas tag.
			</canvas>
		</div>
	</body>
	
	<script>
		function ChartDataPresenter( canvas, chartData, chartDataWindow ) 
		{	
			this._canvas = canvas;
			this._chartData = chartData;
			this._chartDataWindow = chartDataWindow;

			this._canvas.addEventListener( 'keydown', 
				function( event )
				{
					var c0 = ChartDataPresenter.chartWindowPointToChartDataPoint( {x:0, y:0}, this._chartDataWindow );
					var c1 = ChartDataPresenter.chartWindowPointToChartDataPoint( {x:1, y:1}, this._chartDataWindow );
					var s = 0.1;
					var dx = (c1.x - c0.x) * s;
					var dy = (c1.y - c0.y) * s;

					if ( event.keyCode===37 )				// left arrow
					{
						this._chartDataWindow.x -= dx;
					}
					else if ( event.keyCode===39 )			// right arrow
					{
						this._chartDataWindow.x += dx;
					}
					else if ( event.keyCode===38 )			// up arrow
					{
						this._chartDataWindow.y += dy;
					}
					else if ( event.keyCode===40 )			// down arrow
					{
						this._chartDataWindow.y -= dy;
					}
					else if ( event.keyCode===187 ||		// +/=
							  event.keyCode===189 )			// -/_
					{
						var zoomFactor = 1;
						var k = 0.1;
						if ( event.keyCode===187 )
						{	
							zoomFactor -= k;
						}
						else if ( event.keyCode===189 )
						{
							zoomFactor += k;
						}

						var chartDataPoint = {x:0.5, y:0.5};
						chartDataPoint = ChartDataPresenter.chartWindowPointToChartDataPoint( chartDataPoint, this._chartDataWindow );

						this._chartDataWindow.width *= zoomFactor;
						this._chartDataWindow.height *= zoomFactor;

						var chartDataPoint2 = {x:0.5, y:0.5};
						chartDataPoint2 = ChartDataPresenter.chartWindowPointToChartDataPoint( chartDataPoint2, this._chartDataWindow );

						this._chartDataWindow.x -= (chartDataPoint2.x - chartDataPoint.x);
						this._chartDataWindow.y -= (chartDataPoint2.y - chartDataPoint.y);
					}
					else if ( event.keyCode===189 )			// -/_
					{
						this._chartDataWindow.width *= 1.1;
						this._chartDataWindow.height *= 1.1;
					}
					this.update();
				}.bind(this));

			var lastCanvasPoint = null;
			this._canvas.addEventListener( 'mousedown', 
				function( event )
				{
					//http://www.jacklmoore.com/notes/mouse-position/
					var target = event.target || event.srcElement;
					var rect = target.getBoundingClientRect();
					var offsetX = event.clientX - rect.left;
					var offsetY = event.clientY - rect.top;

					lastCanvasPoint = {x:offsetX, y:offsetY};

				}.bind(this));
			this._canvas.addEventListener( 'mousemove', 
				function( event )
				{
					if ( !lastCanvasPoint )
						return;

					var target = event.target || event.srcElement;
					var rect = target.getBoundingClientRect();
					var offsetX = event.clientX - rect.left;
					var offsetY = event.clientY - rect.top;

					var canvasPoint = {x:offsetX, y:offsetY};
					var chartDataPoint = {x:canvasPoint.x, y:canvasPoint.y};
					chartDataPoint = ChartDataPresenter.canvasPointToChartWindowPoint( chartDataPoint, this._canvas );
					chartDataPoint = ChartDataPresenter.chartWindowPointToChartDataPoint( chartDataPoint, this._chartDataWindow );

					var lastChartDataPoint = {x:lastCanvasPoint.x, y:lastCanvasPoint.y};
					lastChartDataPoint = ChartDataPresenter.canvasPointToChartWindowPoint( lastChartDataPoint, this._canvas );
					lastChartDataPoint = ChartDataPresenter.chartWindowPointToChartDataPoint( lastChartDataPoint, this._chartDataWindow );

					var deltaX = chartDataPoint.x - lastChartDataPoint.x;
					var deltaY = chartDataPoint.y - lastChartDataPoint.y;
					this._chartDataWindow.x -= deltaX;
					this._chartDataWindow.y -= deltaY;

					lastCanvasPoint = canvasPoint;
					this.update();

				}.bind(this));
			this._canvas.addEventListener( 'mouseup', 
				function( event )
				{
					lastCanvasPoint = null;
				}.bind(this));


			this._canvas.addEventListener( 'wheel', 
				function( event )
				{
					if ( event.ctrlKey )
					{
						var target = event.target || event.srcElement;
						var rect = target.getBoundingClientRect();
						var offsetX = event.clientX - rect.left;
						var offsetY = event.clientY - rect.top;
 	
						var wheelDelta = 0;
						if ( Math.abs(event.deltaX)>Math.abs(event.deltaY) )
						{
							wheelDelta = event.deltaX;
						}
						else
						{
							wheelDelta = event.deltaY;
						}

						var canvasPoint = {x:offsetX, y:offsetY};
						var chartDataPoint = {x:canvasPoint.x, y:canvasPoint.y};
						chartDataPoint = ChartDataPresenter.canvasPointToChartWindowPoint( chartDataPoint, this._canvas );
						chartDataPoint = ChartDataPresenter.chartWindowPointToChartDataPoint( chartDataPoint, this._chartDataWindow );
console.log(wheelDelta);
						var zoomFactor = 1.0;
						var k = 0.001
						if ( wheelDelta<0 )
						{	
							zoomFactor += k;
						}
						else
						{
							zoomFactor -= k;
						}
						for ( var i=0; i<Math.abs(wheelDelta); ++i )
						{
							this._chartDataWindow.width *= zoomFactor;
							this._chartDataWindow.height *= zoomFactor;
						}

						var chartDataPoint2 = {x:canvasPoint.x, y:canvasPoint.y};
						chartDataPoint2 = ChartDataPresenter.canvasPointToChartWindowPoint( chartDataPoint2, this._canvas );
						chartDataPoint2 = ChartDataPresenter.chartWindowPointToChartDataPoint( chartDataPoint2, this._chartDataWindow );
						this._chartDataWindow.x -= (chartDataPoint2.x - chartDataPoint.x);
						this._chartDataWindow.y -= (chartDataPoint2.y - chartDataPoint.y);
					}
					else
					{
						var c0 = ChartDataPresenter.chartWindowPointToChartDataPoint( {x:0, y:0}, this._chartDataWindow );
						var c1 = ChartDataPresenter.chartWindowPointToChartDataPoint( {x:1, y:1}, this._chartDataWindow );
						var s = 0.001;					// Decent factor for OSX, might differ for other platform/browser 
						var dx = event.deltaX * (c1.x - c0.x) * s;
						var dy = event.deltaY * (c1.y - c0.y) * s;
						this._chartDataWindow.x += dx;	// Proper sign for OSX, might differ for other platform/browser 
						this._chartDataWindow.y -= dy;
					}
					this.update();
					event.preventDefault();
				}.bind(this));
		}

		ChartDataPresenter.prototype.update = function()
		{
			this._canvas.width = this._canvas.clientWidth;
			this._canvas.height = this._canvas.clientHeight;

			var canvasWidth = this._canvas.width;
			var canvasHeight = this._canvas.height;
			var context = this._canvas.getContext("2d");
			//context.lineWidth=1;
			
			// Lines
			var textSize = 14; 
			context.strokeStyle = "#CCCCCC";
			context.font = textSize + "px sans-serif";
			context.fillStyle="#CCCCCC";
			var c0 = ChartDataPresenter.chartWindowPointToChartDataPoint( {x:0, y:0}, this._chartDataWindow );
			var c1 = ChartDataPresenter.chartWindowPointToChartDataPoint( {x:1, y:1}, this._chartDataWindow );
			
			var dy = c1.y - c0.y;
			var yspacing = Math.pow( 10, Math.floor( Math.log10(dy) ) );   // in chart data unit
			var y0 = Math.floor( c0.y / yspacing ) * yspacing;
			var y1 = Math.floor( c1.y / yspacing ) * yspacing;
			for ( var y=y0; y<=y1; y+=yspacing )
			{
				context.beginPath();
				var windowPoint = ChartDataPresenter.chartDataPointToChartWindowPoint( {x:0, y:y}, this._chartDataWindow );
				var canvasPoint = ChartDataPresenter.chartWindowPointToCanvasPoint( windowPoint, this._canvas );
				context.lineTo(0, canvasPoint.y);
				context.lineTo(canvasWidth, canvasPoint.y);
				context.stroke();
				var text = y;
				context.fillText(text, canvasWidth-context.measureText(text).width-5, canvasPoint.y-5);
			}

			var dx = c1.x - c0.x;
			var xspacing = Math.pow( 10, Math.floor( Math.log10(dx) ) );   // in chart data unit
			var x0 = Math.floor( c0.x / xspacing ) * xspacing;
			var x1 = Math.floor( c1.x / xspacing ) * xspacing;
			for ( var x=x0; x<=x1; x+=xspacing )
			{
				context.beginPath();
				var windowPoint = ChartDataPresenter.chartDataPointToChartWindowPoint( {x:x, y:0}, this._chartDataWindow );
				var canvasPoint = ChartDataPresenter.chartWindowPointToCanvasPoint( windowPoint, this._canvas );
				context.lineTo(canvasPoint.x, 0);
				context.lineTo(canvasPoint.x, canvasHeight);
				context.stroke();
				var text = x;
				context.fillText(text, canvasPoint.x+5, textSize+2);
			}

			// Axes
			context.strokeStyle="#222222";
			var originwp = ChartDataPresenter.chartDataPointToChartWindowPoint( {x:0, y:0}, this._chartDataWindow );
			var origincp = ChartDataPresenter.chartWindowPointToCanvasPoint( originwp, this._canvas );
			if ( originwp.y>=0 && originwp.y<=1 )
			{
				context.beginPath();	
				context.lineTo( 0, origincp.y );			
				context.lineTo( canvasWidth, origincp.y );	
				context.stroke();
			}
			if ( originwp.x>=0 && originwp.x<=1 )
			{
				context.beginPath();	
				context.lineTo( origincp.x, 0 );			
				context.lineTo( origincp.x, canvasHeight );	
				context.stroke();
			}
			
			// Data 
			context.beginPath();
			context.strokeStyle="#666666";
			context.fillStyle="#444444";
			for ( var i=0; i<this._chartData.length; i++ )
			{
				var windowPoint = ChartDataPresenter.chartDataPointToChartWindowPoint( this._chartData[i], this._chartDataWindow );
				if ( ChartDataPresenter.isInUnitSquare(windowPoint) )
				{
					var canvasPoint = ChartDataPresenter.chartWindowPointToCanvasPoint( windowPoint, this._canvas );
					context.lineTo(canvasPoint.x, canvasPoint.y);
					context.fillRect(canvasPoint.x-2, canvasPoint.y-2, 4, 4);
				}
			}
			context.stroke();
		};

		ChartDataPresenter.isInUnitSquare = function( point )
		{
			if ( point.x<0 || point.y<0 || point.x>=1 || point.y>=1 )
				return false;
			return true;
		};

		ChartDataPresenter.chartDataPointToChartWindowPoint = function( chartDataPoint, chartDataWindow )
		{
			var x2 = (chartDataPoint.x - chartDataWindow.x) / chartDataWindow.width;
			var y2 = (chartDataPoint.y - chartDataWindow.y) / chartDataWindow.height;
			return {x:x2, y:y2};
		};

		ChartDataPresenter.chartWindowPointToCanvasPoint = function( chartWindowPoint, canvas, roundToInteger )
		{
			var x2 = chartWindowPoint.x * canvas.width;
			var y2 = (1-chartWindowPoint.y) * canvas.height;
			if ( /*roundToInteger===undefined ||*/ roundToInteger )
			{
				x2 = Math.round(x2);
				y2 = Math.round(y2);
			}
			return {x:x2, y:y2};
		};


		ChartDataPresenter.canvasPointToChartWindowPoint = function( canvasPoint, canvas )
		{
			var x2 = canvasPoint.x / canvas.width;
			var y2 = (canvas.height-canvasPoint.y) / canvas.height;
			return {x:x2, y:y2};
		};

		ChartDataPresenter.chartWindowPointToChartDataPoint = function( chartWindowPoint, chartDataWindow )
		{
			var x2 = (chartWindowPoint.x * chartDataWindow.width) + chartDataWindow.x;
			var y2 = (chartWindowPoint.y * chartDataWindow.height) + chartDataWindow.y;
			return {x:x2, y:y2};
		};


		/*function main2()
		{
			var canvas = document.getElementById('theCanvas');
			
			var chartData = [
				{x:0, y:1.6},
				{x:0, y:1.6},
				{x:1, y:2},
				{x:2, y:3},
				{x:3, y:2},
				{x:4, y:2},
				{x:5, y:1}
			];

			chartDataWindow = {
				x: -2,		// the (x,y) origin corresponds to the lower-left corner of the data window
				y: -2,
				width: 10,
				height: 10
			};

			var presenter = new ChartDataPresenter( canvas, chartData, chartDataWindow );
			presenter.update();
		}
		main2();*/

		function makeHttpRequestPromise( url, method, data, headers )
		{
			var promise = new Promise(
				function(resolve, reject) 
				{
					var request = new XMLHttpRequest();
					request.open( method, url );
					if ( headers )
					{
						for ( var header in headers )
						{
							if ( headers.hasOwnProperty(header) )
							{
								request.setRequestHeader(header, headers[header]);
							}
						}
					}

					request.onload = function( event ) 	 
						{
							if ( request.status===200 )
							{
								resolve( request.response );
							}
							else
							{
								reject( new Error(request.status ) );
							}
						};

					request.onerror = function( event )		
						{
							reject( new Error(request.status ) );
						};
			
					try
					{
						request.send(data);
					}
					catch (exception)
					{
						reject( exception );
					}
				});
			return promise;
		}
		
		function createUint8ArrayFromMessageString( messageString )
		{
			// http://stackoverflow.com/questions/1597709/convert-a-string-with-a-hex-representation-of-an-ieee-754-double-into-javascript
			var messageLengthInBytes = 12;
			var buffer = new ArrayBuffer(messageLengthInBytes);
			var uint8Array = new Uint8Array( buffer );
			for ( var i=0; i<messageLengthInBytes; i++ )
			{
				var byteAsHex = messageString.substr( i*2, 2 );
				var byte = parseInt( byteAsHex, 16 );
				uint8Array[i] = byte;
			}
			return uint8Array;
		}

		function getWeatherDataFromUint8Array( uint8Array )
		{
			var dataView = new DataView(uint8Array.buffer);
			var weatherData = {
				pressure: dataView.getUint32(0),		
				temperature: dataView.getFloat32(4),
				humidity: dataView.getUint32(8)
			}
			return weatherData;
		}

		function main()
		{
			makeHttpRequestPromise( '/api/devices/1D80C/messages', 'GET')
				.then(
					function( response )
					{
						var messages = JSON.parse(response);
						for ( var i=0; i<messages.data.length; ++i  )
						{
							var message = messages.data[i];
							var numSecondsSinceEpoch = message.time;
							var date = new Date( numSecondsSinceEpoch * 1000 );
							var weatherData = getWeatherDataFromUint8Array( createUint8ArrayFromMessageString( message.data ) );

							// Store decoded data directly in the response object
							message.weatherData = weatherData;
							message.date = date;
						}

						// Test displaying the data. We convert time in minutes and rebase it ot the first value (of the first page for now)
						var chartData = [];
						var t0 = messages.data[0].time;
						for ( var i=0; i<messages.data.length; ++i  )
						{
							var message = messages.data[i];
							chartData.push( {x:(message.time-t0) / 60, y:message.weatherData.temperature} );
						}
						
						var canvas = document.getElementById('theCanvas');
						canvas.focus();
						chartDataWindow = {
							x: -15,		
							y: -5,
							width: 10 * 50,
							height: 50 
						};

						var presenter = new ChartDataPresenter( canvas, chartData, chartDataWindow );
						presenter.update();
					})
				.catch(
					function( error )
					{
						div.innerHTML = error.toString();
					});
		}

		main();

	</script>
	
</html>
